datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id          String      @id @default(uuid())
  email       String      @unique
  password    String
  name        String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  role        String      @default("USER") // ADMIN, USER
  tasks       Task[]
  timeEntries TimeEntry[]
}

model Client {
  id          String      @id @default(uuid())
  name        String
  email       String?
  phone       String?
  address     String?
  notes       String?
  company     String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  invoices    Invoice[]
  estimates   Estimate[]
  messages    Message[]
  tasks       Task[]
  timeEntries TimeEntry[]
}

model Invoice {
  id          String    @id @default(uuid())
  clientId    String
  client      Client    @relation(fields: [clientId], references: [id])
  number      String    @unique
  date        DateTime
  dueDate     DateTime
  status      String    @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED
  items       Json      // Array of { description, quantity, price, tax }
  total       Float
  currency    String    @default("USD")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Recurring
  isRecurring Boolean   @default(false)
  frequency   String?   // WEEKLY, MONTHLY, ANNUAL
  nextRun     DateTime?
  
  // Payments
  payments    Payment[]
}

model Estimate {
  id          String   @id @default(uuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id])
  number      String   @unique
  date        DateTime
  expiryDate  DateTime?
  status      String   @default("DRAFT") // DRAFT, SENT, ACCEPTED, REJECTED
  items       Json
  total       Float
  currency    String   @default("USD")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Proposal {
  id          String   @id @default(uuid())
  title       String
  content     String   // HTML or Markdown content
  status      String   @default("DRAFT")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Template {
  id          String   @id @default(uuid())
  type        String   // INVOICE, ESTIMATE, EMAIL, SMS, WHATSAPP, PROPOSAL
  name        String
  content     String
  style       Json?    // Design settings: colors, fonts, spacing
  category    String   @default("CUSTOM") // MODERN, CLEAN, PREMIUM, CLASSIC, CUSTOM
  logoUrl     String?  // Base64 encoded logo or URL
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


model ProviderConfig {
  id          String   @id @default(uuid())
  type        String   // SMS, EMAIL, WHATSAPP
  provider    String   // TWILIO, ESMS, GMAIL, SMTP, WAACS, WHATSCLOUD, OFFICIAL_WA
  name        String?  // Friendly name
  isActive    Boolean  @default(false)
  credentials String   // Encrypted JSON string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Message {
  id          String   @id @default(uuid())
  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])
  type        String   // SMS, EMAIL, WHATSAPP
  direction   String   // INBOUND, OUTBOUND
  status      String   // SENT, DELIVERED, FAILED, READ
  from        String
  to          String
  content     String
  provider    String?  // Who sent it?
  externalId  String?  // ID from the provider
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Payment {
  id              String   @id @default(uuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id])
  amount          Float
  stripePaymentId String?
  stripeSessionId String?
  status          String   @default("PENDING") // PENDING, COMPLETED, FAILED, REFUNDED
  method          String   @default("STRIPE") // STRIPE, MANUAL, BANK_TRANSFER
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Task {
  id          String      @id @default(uuid())
  title       String
  description String?
  clientId    String?
  client      Client?     @relation(fields: [clientId], references: [id])
  assigneeId  String?
  assignee    User?       @relation(fields: [assigneeId], references: [id])
  dueDate     DateTime?
  priority    String      @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status      String      @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  timeEntries TimeEntry[]
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String   @default("#6366f1")
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String   // CREATE, UPDATE, DELETE
  entity    String   // Client, Invoice, etc.
  entityId  String
  details   Json?
  createdAt DateTime @default(now())
}

model Attachment {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  size         Int      // bytes
  path         String   // storage path
  entityType   String   // CLIENT, INVOICE, ESTIMATE, PROPOSAL, EXPENSE
  entityId     String
  uploadedBy   String?
  createdAt    DateTime @default(now())
}

model Expense {
  id          String   @id @default(uuid())
  description String
  amount      Float
  date        DateTime
  category    String
  vendor      String?
  notes       String?
  receiptUrl  String?  // Link to attachment
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ExpenseCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String   @default("#6366f1")
  createdAt DateTime @default(now())
}

model ReminderConfig {
  id         String   @id @default(uuid())
  type       String   // INVOICE_OVERDUE, INVOICE_DUE_SOON, ESTIMATE_FOLLOWUP
  enabled    Boolean  @default(true)
  daysBefore Int?     // For due soon reminders
  daysAfter  Int?     // For overdue reminders
  templateId String?  // Email template
  channels   Json     // ["EMAIL", "SMS"]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ReminderLog {
  id         String   @id @default(uuid())
  entityType String   // INVOICE, ESTIMATE
  entityId   String
  type       String
  channel    String   // EMAIL, SMS
  recipient  String
  status     String   // SENT, FAILED
  sentAt     DateTime @default(now())
}

model TimeEntry {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  clientId    String?
  client      Client?   @relation(fields: [clientId], references: [id])
  taskId      String?
  task        Task?     @relation(fields: [taskId], references: [id])
  description String
  startTime   DateTime
  endTime     DateTime?
  duration    Int?      // minutes
  hourlyRate  Float?
  billable    Boolean   @default(true)
  invoiced    Boolean   @default(false)
  invoiceId   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // ADMIN, MANAGER, STAFF, ACCOUNTANT, CUSTOM
  description String?
  permissions Json     // Array of permission strings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Signature {
  id            String    @id @default(uuid())
  entityType    String    // PROPOSAL, ESTIMATE, CONTRACT
  entityId      String
  signerName    String
  signerEmail   String
  signedAt      DateTime?
  status        String    @default("PENDING") // PENDING, SIGNED, DECLINED
  ipAddress     String?
  signatureData String?   // Base64 signature image
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
